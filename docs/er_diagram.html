<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´æœåº—è¿›é”€å­˜ç³»ç»Ÿ - ERå›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            padding: 20px;
            margin: 0;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1400px;
            margin: 0 auto;
        }
        .mermaid {
            display: flex;
            justify-content: center;
        }
        .tip {
            text-align: center;
            color: #666;
            margin-top: 20px;
            font-size: 14px;
        }
        button {
            display: block;
            margin: 20px auto;
            padding: 10px 30px;
            font-size: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <h1>ğŸ æ°´æœåº—è¿›é”€å­˜ç³»ç»Ÿ - æ•°æ®åº“ ER å›¾</h1>
    
    <div class="container">
        <div class="mermaid">
erDiagram
    %% ==================== ç”¨æˆ·ä¸é—¨åº— ====================
    USERS ||--o{ USER_STORES : "æ‹¥æœ‰"
    STORES ||--o{ USER_STORES : "åˆ†é…"
    
    USERS {
        string username PK "ç”¨æˆ·å"
        string password "å¯†ç "
        string name "å§“å"
        string role "è§’è‰²"
        string email "é‚®ç®±"
    }
    
    STORES {
        string id PK "é—¨åº—ID"
        string name "åç§°"
        string city "åŸå¸‚"
        string address "åœ°å€"
        string phone "ç”µè¯"
    }

    %% ==================== å•†å“ä¸åº“å­˜ ====================
    PRODUCTS ||--o{ INVENTORY : "åº“å­˜"
    STORES ||--o{ INVENTORY : "å­˜æ”¾"
    INVENTORY ||--o{ ADJUSTMENTS : "è°ƒæ•´"
    
    PRODUCTS {
        string id PK "å•†å“ID"
        string name "åç§°"
        string category "åˆ†ç±»"
        decimal price_base "åŸºå‡†ä»·"
        string status "çŠ¶æ€"
    }
    
    INVENTORY {
        string id PK "åº“å­˜ID"
        string store_id FK "é—¨åº—"
        string product_id FK "å•†å“"
        decimal on_hand_kg "åº“å­˜é‡"
        decimal unit_cost "æˆæœ¬"
        decimal unit_price "å”®ä»·"
        decimal reorder_level "é¢„è­¦çº¿"
    }
    
    ADJUSTMENTS {
        string id PK "è°ƒæ•´ID"
        string inventory_id FK "åº“å­˜"
        string reason "åŸå› "
        decimal delta_kg "è°ƒæ•´é‡"
        datetime created_at "æ—¶é—´"
    }

    %% ==================== åˆä½œä¼™ä¼´ ====================
    PARTNERS ||--o{ PURCHASE_ORDERS : "ä¾›è´§"
    PARTNERS ||--o{ SALES_ORDERS : "è´­ä¹°"
    
    PARTNERS {
        string id PK "ä¼™ä¼´ID"
        string type "ç±»å‹"
        string name "åç§°"
        string contact_name "è”ç³»äºº"
        string phone "ç”µè¯"
        int payment_term_days "è´¦æœŸ"
    }

    %% ==================== é‡‡è´­ç®¡ç† ====================
    STORES ||--o{ PURCHASE_ORDERS : "é‡‡è´­"
    PURCHASE_ORDERS ||--o{ PURCHASE_ORDER_LINES : "æ˜ç»†"
    
    PURCHASE_ORDERS {
        string id PK "é‡‡è´­å•ID"
        string store_id FK "é—¨åº—"
        string supplier_id FK "ä¾›åº”å•†"
        string status "çŠ¶æ€"
        date expected_date "é¢„è®¡åˆ°è´§"
    }
    
    PURCHASE_ORDER_LINES {
        bigint id PK "è¡ŒID"
        string order_id FK "é‡‡è´­å•"
        string product_id "å•†å“"
        decimal quantity_kg "æ•°é‡"
        decimal unit_cost "å•ä»·"
    }

    %% ==================== é”€å”®ç®¡ç† ====================
    STORES ||--o{ SALES_ORDERS : "é”€å”®"
    SALES_ORDERS ||--o| INVOICES : "å‘ç¥¨"
    
    SALES_ORDERS {
        string id PK "é”€å”®å•ID"
        string store_id FK "é—¨åº—"
        string customer_id FK "å®¢æˆ·"
        date date "æ—¥æœŸ"
        decimal quantity_kg "æ•°é‡"
        decimal unit_price "å•ä»·"
        string status "çŠ¶æ€"
    }
    
    INVOICES {
        string id PK "å‘ç¥¨ID"
        string store_id FK "é—¨åº—"
        string order_id FK "è®¢å•"
        decimal amount "é‡‘é¢"
        string status "çŠ¶æ€"
    }

    %% ==================== ä¼šå‘˜ç®¡ç† ====================
    MEMBERS {
        string id PK "ä¼šå‘˜ID"
        string name "å§“å"
        string phone "ç”µè¯"
        decimal balance "ä½™é¢"
        decimal points "ç§¯åˆ†"
        string tier "ç­‰çº§"
    }

    %% ==================== ç³»ç»Ÿé…ç½® ====================
    ROLE_MATRIX ||--o{ ROLE_PERMISSIONS : "æƒé™"
    
    ROLE_MATRIX {
        string role PK "è§’è‰²"
        string label "åç§°"
    }
    
    SYSTEM_PARAMETERS {
        string param_key PK "å‚æ•°é”®"
        string param_value "å‚æ•°å€¼"
        string description "æè¿°"
    }
    
    AUDIT_LOGS {
        string id PK "æ—¥å¿—ID"
        string actor "æ“ä½œäºº"
        string action "æ“ä½œ"
        string entity "å®ä½“"
        datetime timestamp "æ—¶é—´"
    }
        </div>
    </div>
    
    <button onclick="saveSVG()">ğŸ’¾ ä¿å­˜ä¸º SVG å›¾ç‰‡</button>
    
    <p class="tip">æç¤ºï¼šç‚¹å‡»æŒ‰é’®ä¿å­˜ SVGï¼Œæˆ–å³é”®å›¾è¡¨é€‰æ‹©"å¦å­˜ä¸ºå›¾ç‰‡"</p>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            er: {
                layoutDirection: 'TB',
                minEntityWidth: 100,
                minEntityHeight: 75,
                entityPadding: 15,
                useMaxWidth: false
            }
        });
        
        function saveSVG() {
            const svg = document.querySelector('.mermaid svg');
            if (svg) {
                const svgData = new XMLSerializer().serializeToString(svg);
                const blob = new Blob([svgData], {type: 'image/svg+xml'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'fruitshop_er_diagram.svg';
                a.click();
                URL.revokeObjectURL(url);
            }
        }
    </script>
</body>
</html>
