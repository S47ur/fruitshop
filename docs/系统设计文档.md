# 水果店进销存系统 — 系统设计文档

## 1. 系统概览
- 技术栈：后端 Spring Boot 3.2 + Java 17 + Spring Security + JPA/Hibernate；前端 Vue 3 + TypeScript + Pinia + Vue Router + ECharts；接口通信 REST + Axios。
- 运行环境：开发使用 H2 内存库，生产使用 MySQL；支持通过 spring profile 切换。
- 目标：覆盖登录/注册、库存、采购、销售、财务、会员、主数据与系统参数管理，保证角色化访问控制与统一异常返回。

## 2. 整体架构
- 分层：Controller (REST) → Service (业务) → Repository (JPA) → Entity (数据) → DB。
- 配置：`application.yml` 多 profile；`WebConfig` 统一 CORS；`DataSeeder` 初始化演示数据。
- 返回包装：`ApiResponse<T>` 统一 success/error 结构，前端按 `code`/`message`/`data` 处理。
- 会话与认证：JWT/Token 由 `AuthController` 下发，前端存储后以 `Authorization` 头发送；路由守卫检查登录态。

## 3. 后端设计
- 控制器：Auth、Enterprise、Inventory、Invoice、Member、Purchase、Sales、SystemParameter（路径以 `/api/` 开头）。
- 服务：对应业务服务封装事务与权限校验，避免控制器直接操作仓储。
- 仓储：基于 `JpaRepository` 的 18 个仓储类，命名查询 + 动态条件组合。
- 实体：22 个实体（User、RoleMatrix、Store、Product、Inventory、PurchaseOrder、SalesOrder、Invoice、Partner、Member、ApprovalFlow 等），使用 JPA 映射，主键多为自增或雪花/UUID。
- 数据初始化：`DataSeeder` 在 dev/内存库模式下写入演示用户、商品与库存。

## 4. 前端设计
- 架构：Vite + Vue 3 组合式 API，入口 `src/main.ts`，根组件 `App.vue`，`AppShell` 负责布局与导航。
- 路由：`router/index.ts` 配置受保护路由（Dashboard、Inventory、Procurement、Sales、Finance、System 等）；登录/注册开放；导航守卫校验 token 与角色。
- 状态：Pinia `useAuthStore` 管理用户与 token；`useInventoryStore`、`useEnterpriseStore` 管理库存与主数据；toast 事件总线 `useToastBus`。
- 数据访问：`services/dataGateway.ts` 封装 Axios 基址与拦截器；`mockBackend.ts` 提供本地演示数据；`idTranslator.ts` 做字典翻译。
- UI：ECharts 图表组件（Donut/HorizontalBar/LineArea）、卡片/表格/表单组件可复用；`ToastHost`、`PaginationControl` 等通用组件。

## 5. 权限模型（RBAC）
- 角色：ROLE_OWNER（老板）、ROLE_MANAGER（经理）、ROLE_CASHIER（收银）、ROLE_AUDITOR（审计）。
- 存储：`RoleMatrix` 定义角色-权限矩阵，`User` 关联角色集合；控制器基于注解或服务侧校验。
- 粒度：
  - OWNER：全量读写，包括系统参数与用户管理。
  - MANAGER：经营类读写（库存、采购、销售、财务），受限系统配置。
  - CASHIER：收银/销售录入与查询，不能改系统参数。
  - AUDITOR：只读全局数据，用于审计/对账。
- 前端控制：
  - 路由守卫：未登录跳转登录，角色不匹配跳转无权页或提示。
  - 组件级：按 `role`/`permission` 控制按钮显隐；表单仅读模式。
- 典型流程：登录获取 token → 保存至 store/localStorage → Axios 在请求头附带 → 后端基于 token 解析用户与角色 → 控制器/服务校验角色 → 返回结果或 403。

## 6. 异常处理与返回
- 全局处理：`GlobalExceptionHandler` 使用 `@RestControllerAdvice`，捕获 `RuntimeException` 与兜底 `Exception`，返回 `ApiResponse.error(code,message)`。
- 返回格式示例：
  ```json
  { "success": false, "code": "BUSINESS_ERROR", "message": "库存不足", "data": null }
  ```
- 校验/业务错误：在服务层抛出带语义的 `RuntimeException` 或自定义业务异常，统一转换。
- 安全错误：认证失败返回 401，鉴权失败返回 403；记录审计日志（可在拦截器/过滤器扩展）。
- 前端处理：Axios 响应拦截器统一检查 `success`/`code`，toast 显示 message，必要时跳转登录。

## 7. 主要业务流
- 登录/注册：AuthController 处理注册与登录，成功后下发 token；前端存储并刷新路由权限。
- 库存查询与调整：InventoryController 查询库存、预警；库存变更由采购/销售闭环驱动，避免直接裸写。
- 采购：创建采购单 → 校验供应商与商品 → 按审批流可选审核 → 入库后写库存变更、生成应付。
- 销售：创建销售单 → 库存占用与扣减 → 生成应收与收款记录 → 收银/经理可操作，审计只读。
- 财务/发票：InvoiceController 管理发票与收付款信息，关联销售/采购单。
- 会员：MemberController 管理会员信息与积分/折扣数据。
- 系统参数：SystemParameterController 仅 OWNER/MANAGER 可改，其他角色只读。

## 8. API 设计摘要
- 路径前缀：`/api/**`，JSON 输入输出，使用标准 HTTP 动词。
- 常用端点（示例）：
  - `POST /api/auth/login`，`POST /api/auth/register`
  - `GET /api/inventory`，`GET /api/inventory/low-stock`
  - `POST /api/purchase`，`POST /api/sales`
  - `GET /api/invoice`，`POST /api/invoice`
  - `GET /api/member`，`POST /api/member`
  - `GET /api/system/parameter`，`POST /api/system/parameter`
- 约定：
  - 成功返回 `success=true` 和业务数据；失败返回 `success=false`、业务 `code` 与 `message`。
  - 分页参数统一 `page`/`size`，排序可选 `sort`。

## 9. 非功能性设计
- 安全：基于角色的鉴权；CORS 限制来源；建议在生产启用 HTTPS 与 HTTP-only cookies。
- 性能：JPA 懒加载 + 必要的抓取优化；可为高频查询增加索引。
- 可运维性：Profile 区分配置；容器化时通过环境变量注入 DB/端口；日志按级别输出。
- 可测试性：前端 Vitest；后端可补充 Spring Boot Test/MockMvc 覆盖关键流程。

## 10. 后续改进建议
- 引入统一的业务异常类与错误码枚举，替代裸 `RuntimeException`。
- 在安全链路上增加 JWT 过滤器与刷新机制，支持 token 续期与强制下线。
- 审计日志：为敏感操作记录操作者、时间、参数与结果。
- 数据权限：细粒度到门店/组织的行级过滤。
- 自动化测试：补充采购/销售/库存的端到端用例，前端增加路由与权限的单测。
